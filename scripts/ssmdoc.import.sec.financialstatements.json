{
   "schemaVersion":"2.2",
   "description":"Downloads SEC Financial Statment and Notes Source files and moves them to S3",
   "parameters":{
        "SourceFileTargetBucketLocation": {
          "type": "String",
          "description": "Bucket to store the SEC target files in."
        }
    },
    "mainSteps":[
      {
        "action":"aws:runShellScript",
        "name":"DownloadAndImportSECfinancialStatementsAndNotesintoS3",
        "inputs":{
            "runCommand": [
                "rm -rf SEC/sourceExports/financial-statement-and-notes/",
                "year=2009",
                "while [ $year -le 2020 ]",
                "do",
                "   quarter=1",
                "   while [ $quarter -le 4 ]",
                "   do",
                "      wget -q https://www.sec.gov/files/dera/data/financial-statement-and-notes-data-sets/${year}q${quarter}_notes.zip -P SEC/sourceExports/financial-statement-and-notes/${year}_Q${quarter}/",
                "      echo ${year}_Q${quarter}",
                "      quarter=`expr $quarter + 1`",
                "   done",
                "   year=`expr $year + 1`",
                "done",
                "year=2020",
                "month=10",
                "while [ $year -le $(date +%Y) ]",
                "do",
                "   while [ $month -le 12 ]",
                "   do",
                "      formatedMonth=$(printf '%02d' $month)",
                "      wget -q https://www.sec.gov/files/dera/data/financial-statement-and-notes-data-sets/${year}_${formatedMonth}_notes.zip -P SEC/sourceExports/financial-statement-and-notes/${year}_${formatedMonth}/",
                "      echo ${year}_${formatedMonth}",
                "      month=`expr $month + 1`",
                "   done",
                "   year=`expr $year + 1`",
                "   month=1",
                "done", 
                "find SEC/sourceExports/financial-statement-and-notes/ -depth -name '*.zip' -execdir /usr/bin/unzip -n {} \\; -delete",
                "rm -rf SEC/groupedExports/",
                "mkdir -p SEC/groupedExports/calcuation/",
                "mkdir -p SEC/groupedExports/dimension/", 
                "mkdir -p SEC/groupedExports/number/", 
                "mkdir -p SEC/groupedExports/presentation/", 
                "mkdir -p SEC/groupedExports/rendering/", 
                "mkdir -p SEC/groupedExports/submission/", 
                "mkdir -p SEC/groupedExports/tag/", 
                "mkdir -p SEC/groupedExports/text/", 
                "find SEC/sourceExports/financial-statement-and-notes/ -name 'cal.tsv' -type f -exec mv --backup=numbered '{}' SEC/groupedExports/calcuation \\;",
                "find SEC/sourceExports/financial-statement-and-notes/ -name 'dim.tsv' -type f -exec mv --backup=numbered '{}' SEC/groupedExports/dimension \\;",
                "find SEC/sourceExports/financial-statement-and-notes/ -name 'num.tsv' -type f -exec mv --backup=numbered '{}' SEC/groupedExports/number \\;",
                "find SEC/sourceExports/financial-statement-and-notes/ -name 'pre.tsv' -type f -exec mv --backup=numbered '{}' SEC/groupedExports/presentation \\;",
                "find SEC/sourceExports/financial-statement-and-notes/ -name 'ren.tsv' -type f -exec mv --backup=numbered '{}' SEC/groupedExports/rendering \\;",
                "find SEC/sourceExports/financial-statement-and-notes/ -name 'sub.tsv' -type f -exec mv --backup=numbered '{}' SEC/groupedExports/submission \\;",
                "find SEC/sourceExports/financial-statement-and-notes/ -name 'tag.tsv' -type f -exec mv --backup=numbered '{}' SEC/groupedExports/tag \\;",
                "find SEC/sourceExports/financial-statement-and-notes/ -name 'txt.tsv' -type f -exec mv --backup=numbered '{}' SEC/groupedExports/text \\;",
                "aws s3 sync SEC/groupedExports/ s3://{{SourceFileTargetBucketLocation}}/SEC/groupedExports/"
            ]
         }
      }
   ]
}